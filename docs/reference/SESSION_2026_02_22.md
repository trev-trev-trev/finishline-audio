# Engineering Session: 2026-02-22

**Duration**: ~6 hours  
**Commits**: 7e401ff, 79f9e3f, 59224c6, 0a64c50  
**Primary Focus**: Master track fixes, smoke test expansion, documentation consolidation

---

## Critical Fixes Applied

### 1. Master Track Indexing (BREAKING CHANGE)

**Problem**: All commands used `track_id=0` for master, but master is actually `track_id=-1000`

**Track indexing scheme** (AbletonOSC):
- Regular tracks: 0, 1, 2, ...
- Return tracks: -1, -2, -3, ...
- **Master track: -1000**

**Files fixed**:
- `src/flaas/targets.py` - Added `MASTER_TRACK_ID = -1000`
- `src/flaas/plan.py` - Uses MASTER_TRACK_ID
- `src/flaas/apply.py` - Uses MASTER_TRACK_ID
- `src/flaas/verify.py` - Defaults to MASTER_TRACK_ID

**Impact**: All master track operations now work correctly (plan-gain, apply, verify)

---

### 2. Device Resolution Fix (CRITICAL BUG)

**Problem**: Response from `/live/track/get/devices/name` includes track_id as first element

**Response format**: `(track_id, name0, name1, name2, ...)`

**WRONG implementations** (off-by-one errors):
```python
device_names = list(response[2:])  # Skips track_id AND first device
device_id = response.index("Utility")  # Indexes full tuple
```

**CORRECT implementation**:
```python
names = list(response)[1:]  # Skip only track_id
device_id = names.index("Utility")  # Index into device names only
```

**Root cause**: Misunderstood response structure, assumed `(track_id, device_count, name0, name1, ...)` but actual is `(track_id, name0, name1, ...)`

---

### 3. Shared Utility Device Resolver

**Problem**: Code duplication across plan.py, apply.py, verify.py

**Solution**: Created shared resolver in `targets.py`

**Function**: `resolve_utility_device_id(target: OscTarget) -> int`
- Queries `/live/track/get/devices/name` with `[MASTER_TRACK_ID]`
- Drops first element (track_id) from response
- Finds "Utility" case-insensitively
- Returns device index
- Raises SystemExit(20) if not found

**Files updated**:
- `src/flaas/targets.py` - Added resolver
- `src/flaas/plan.py` - Uses shared resolver
- `src/flaas/apply.py` - Uses shared resolver
- `src/flaas/verify.py` - Uses shared resolver

---

## New Features

### 1. Three Lanes Smoke Tests

**Created**: Three-tier smoke test system with distinct purposes

**Lanes**:
1. `make smoke` - Read-only (~7s, 8 tests) - Fast sanity check
2. `make write-fast` - Dev loop gate (~9s, 4 tests) - Minimal write validation
3. `make write` - Pre-commit gate (~39s, 13 tests) - Full validation

**File**: `scripts/run_smoke_tests.sh`

**CI-style exit codes**:
- 0: PASS (all tests passed)
- 10: SOFT-SKIP ONLY (all tests skipped)
- 20: READ FAILURE (OSC communication, scan, inspect)
- 30: WRITE FAILURE (parameter set operations)

**Key features**:
- Targeted scan (--tracks flag) for speed
- Retry logic with configurable timeouts
- Scan cache reuse (30s TTL)
- JSON + text reports
- 5-line console summary

**Makefile shortcuts**: `make smoke`, `make write-fast`, `make write`

---

### 2. Plugin Device Safe Param Test

**Command**: `flaas device-set-safe-param <track_id> <device_id>`

**Purpose**: Generic plugin device write+revert validation

**Behavior**:
- Auto-generates device map if missing
- Selects safe parameter by preference:
  - Prefers: wetDry, wet, dry, mix, depth, rate, feedback, gain, level
  - Avoids: device on, on, bypass, enable, mode, program, preset
- Requires: is_quantized=false, (max-min) >= 0.1
- Sets value += (max-min)*0.02, clamped
- Verifies change
- Reverts to original
- Verifies revert

**Exit codes**:
- 0: success
- 20: read failure
- 30: write failure

**Integration**: Added to `make write` (skipped in `make write-fast`)

**File**: `src/flaas/device_set_safe_param.py`

**Validated on**: Track 41, device 1 (ValhallaSpaceModulator, wetDry param)

---

### 3. Version Checking System

**Files**:
- `src/flaas/version.py` - FLAAS_VERSION, ABLETONOSC_VERSION_EXPECTED
- `abletonosc/constants.py` - ABLETONOSC_VERSION

**Commands**:
- `flaas --version` - Shows FLAAS version + expected AbletonOSC version
- `flaas remote-version` - Queries remote AbletonOSC version, checks match

**Enforcement**: Smoke tests fail with exit code 20 on version mismatch

**Current version**: 2026-02-22.1 (both sides)

---

## Documentation Consolidation

**Reduction**: 48% line count reduction (767 → 400 core doc lines)

**Eliminated**: 15 redundant report files, all duplicate content

**New structure**:
- `START_HERE.md` - Entry point (10 lines)
- `QUICKSTART.md` - Instant orientation (47 lines)
- `STATE.md` - Single source of truth (145 lines)
- `README.md` - Project overview (35 lines)
- `docs/status/STATUS.md` - Operating procedures (255 lines)

**Philosophy applied**: "If you can cut it out and nothing changes, cut it out."

---

## Current Blocker

**Export crash**: Ableton hangs when rendering master track

**Diagnosis**: Third-party plugins (ValhallaSpaceModulator, StudioVerse) cause render instability

**Triage steps**:
1. Disable third-party plugins on track 41
2. Attempt 4-8 bar export to `output/master_iter1.wav`
3. If succeeds: Re-enable plugins one-by-one to find culprit
4. Validate gain adjustment via `flaas verify-audio output/master_iter1.wav`

**Current state**: Waiting for manual export with plugins disabled

---

## Applied State (NON-NEGOTIABLE INVARIANTS)

**Master track** (track_id=-1000):
- Utility device at index 0
- Gain: **-0.750 linear** (normalized: 0.125)
- Delta applied: **+0.250** (from plan-gain)
- **NOT RESET** - gain adjustment is live in Ableton

**Track 41** "42-52 long chords":
- EQ Eight (device 0)
- ValhallaSpaceModulator (device 1) - Suspect for export crash
- StudioVerse (device 2) - Suspect for export crash

**Actions file**: `data/actions/actions.json` contains delta +0.250

---

## Priority Correction

**Real bottleneck**: Export loop must work before endpoint expansion

**Loop**: `plan-gain → apply → export → verify-audio → repeat`

**Current status**: **BLOCKED at export**

**Documentation created**:
- `PRIORITY.md` - Execution order correction
- `docs/ENDPOINT_REGISTRY.json` - Bridge between patterns and codegen
- `DISCOVERY.md` - Control discovery framework (blocked until export works)
- `NEXT_CHAPTER.md` - Generation roadmap (blocked until export works)

**Discovered**: 108 OSC endpoint patterns available (extraction complete)

**Target** (after export works): 300-500 commands, 95%+ Ableton coverage

---

## Critical Learnings

1. **Master track uses special index -1000** (not 0)
2. **Device name queries return track_id as first element** (must skip it)
3. **Utility device index is dynamic** (must query, can't assume 0)
4. **Export requires correct "Rendered Track" setting** (Master, not All Tracks)
5. **Third-party plugins can hang render** (disable during triage)
6. **Documentation must not leap-frog execution** (export loop is gate)
7. **Endpoint patterns need full specs** (args, response, safety, quirks)

---

## Next Actions

1. **IMMEDIATE**: Fix export crash (disable plugins, test 4-8 bars)
2. **AFTER EXPORT WORKS**: Populate ENDPOINT_REGISTRY.json (top 50 endpoints)
3. **THEN**: Generate commands from registry in batches
4. **GOAL**: 300-500 commands, complete Ableton mirror

---

## Session Metrics

**Commits**: 4 major commits
- 7e401ff: Documentation consolidation (48% reduction)
- 79f9e3f: Discovery framework
- 59224c6: Priority correction
- 0a64c50: Doc conflict fixes

**Files created**: 12 new files
**Files modified**: 8 core files
**Lines added**: ~2000
**Lines removed**: ~400 (net +1600)
**Commands added**: 3 (remote-version, device-set-safe-param, version constants)
**Smoke test lanes**: 3 (smoke, write-fast, write)
**Exit codes**: 4 (0, 10, 20, 30)

---

**End of Session Summary**
